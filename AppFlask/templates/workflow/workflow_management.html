{% extends 'base.html' %}

{% block title %}Gestion des workflows{% endblock %}

{% block content %}
<section id="content">
    <!-- NAVBAR -->
    <nav>
        <i class='bx bx-menu'></i>
        <a href="#" class="nav-link">Catégories</a>
        <form action="#">
            <div class="form-input">
                <input type="search" placeholder="Rechercher...">
                <button type="submit" class="search-btn"><i class='bx bx-search'></i></button>
            </div>
        </form>
        <input type="checkbox" id="switch-mode" hidden>
        <label for="switch-mode" class="switch-mode"></label>
        <a href="#" class="notification">
            <i class='bx bxs-bell'></i>
            <span class="num">8</span>
        </a>
        <a href="#" class="profile">
            <img src="{{ url_for('static', filename='img/people.png') }}" alt="">
        </a>
    </nav>
    <!-- NAVBAR -->

    <!-- MAIN -->
    <main>
        <div class="head-title">
            <div class="left">
                <h1>Workflows</h1>
                <ul class="breadcrumb">
                    <li><a href="{{ url_for('dashboard.home') }}">Tableau de bord</a></li>
                    <li><i class='bx bx-chevron-right'></i></li>
                    <li><a class="active" href="{{ url_for('workflow.list_workflows') }}">Workflows</a></li>
                </ul>
            </div>
            <a href="#" class="btn-download" id="newWorkflowBtn">
                <i class='bx bx-plus'></i>
                <span class="text">Nouveau workflow</span>
            </a>
        </div>

        <!-- Statistiques -->
        <ul class="box-info">
            <li>
                <i class='bx bx-git-branch'></i>
                <span class="text">
                    <h3 id="totalWorkflows">0</h3>
                    <p>Modèles de workflow</p>
                </span>
            </li>
            <li>
                <i class='bx bx-time-five'></i>
                <span class="text">
                    <h3 id="pendingApprovals">0</h3>
                    <p>En attente d'approbation</p>
                </span>
            </li>
            <li>
                <i class='bx bx-check-circle'></i>
                <span class="text">
                    <h3 id="completedToday">0</h3>
                    <p>Terminés aujourd'hui</p>
                </span>
            </li>
        </ul>

        <!-- Onglets -->
        <div class="table-data">
            <div class="workflow-tabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="templates">Modèles de workflows</button>
                    <button class="tab-btn" data-tab="approvals">Mes approbations</button>
                    <button class="tab-btn" data-tab="instances">Instances actives</button>
                </div>

                <!-- Onglet Modèles de workflows -->
                <div class="tab-content active" id="templates">
                    <div class="order">
                        <div class="head">
                            <h3>Modèles de workflows</h3>
                            <div class="filter-controls">
                                <input type="text" id="searchWorkflows" placeholder="Rechercher un workflow...">
                                <select id="statusFilter">
                                    <option value="all">Tous les statuts</option>
                                    <option value="ACTIVE">Actif</option>
                                    <option value="INACTIVE">Inactif</option>
                                </select>
                            </div>
                        </div>
                        <table id="workflowTemplatesTable">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Description</th>
                                    <th>Créateur</th>
                                    <th>Statut</th>
                                    <th>Instances</th>
                                    <th>Créé le</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Contenu chargé via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Onglet Approbations -->
                <div class="tab-content" id="approvals">
                    <div class="order">
                        <div class="head">
                            <h3>Documents en attente d'approbation</h3>
                        </div>
                        <table id="pendingApprovalsTable">
                            <thead>
                                <tr>
                                    <th>Document</th>
                                    <th>Workflow</th>
                                    <th>Étape courante</th>
                                    <th>Initiateur</th>
                                    <th>Depuis</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Contenu chargé via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Onglet Instances actives -->
                <div class="tab-content" id="instances">
                    <div class="order">
                        <div class="head">
                            <h3>Instances de workflow actives</h3>
                        </div>
                        <div style="text-align: center; padding: 40px; color: #777;">
                            Fonctionnalité à implémenter : liste des instances actives
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de création de workflow -->
        <div id="createWorkflowModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Créer un nouveau workflow</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Pour créer des workflows avec une interface moderne, utilisez l'interface React dans l'application frontend.</p>
                    <p>Cette fonctionnalité sera bientôt disponible dans cette interface.</p>
                </div>
            </div>
        </div>

        <!-- Modal d'approbation -->
        <div id="approveModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Approuver l'étape</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="approveForm" method="POST">
                        <div class="form-group">
                            <label for="approveComment">Commentaire (optionnel)</label>
                            <textarea id="approveComment" name="commentaire" rows="3" 
                                    placeholder="Ajoutez un commentaire..."></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('approveModal')">Annuler</button>
                            <button type="submit" class="btn btn-success">Approuver</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de rejet -->
        <div id="rejectModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Rejeter l'étape</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="rejectForm" method="POST">
                        <div class="form-group">
                            <label for="rejectComment">Motif du rejet *</label>
                            <textarea id="rejectComment" name="commentaire" rows="3" 
                                    placeholder="Expliquez pourquoi vous rejetez cette étape..." required></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('rejectModal')">Annuler</button>
                            <button type="submit" class="btn btn-danger">Rejeter</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
</section>

<style>
.workflow-tabs {
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 7px 25px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.tab-buttons {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.tab-btn {
    flex: 1;
    padding: 15px 20px;
    border: none;
    background: none;
    cursor: pointer;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.3s ease;
}

.tab-btn.active {
    background: #fff;
    color: #3a8bfd;
    border-bottom: 3px solid #3a8bfd;
}

.tab-btn:hover:not(.active) {
    background: #e9ecef;
    color: #495057;
}

.tab-content {
    display: none;
    padding: 20px;
}

.tab-content.active {
    display: block;
}

.filter-controls {
    display: flex;
    gap: 15px;
    align-items: center;
}

.filter-controls input,
.filter-controls select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.filter-controls input {
    width: 250px;
}

.filter-controls select {
    width: 150px;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 1px solid #dee2e6;
}

.modal-header h3 {
    margin: 0;
    color: #2c3e50;
}

.modal-header .close {
    font-size: 24px;
    cursor: pointer;
    color: #6c757d;
    transition: color 0.3s ease;
}

.modal-header .close:hover {
    color: #dc3545;
}

.modal-body {
    padding: 25px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #2c3e50;
}

.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-family: inherit;
    font-size: 14px;
    resize: vertical;
}

.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    transition: all 0.3s ease;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
}

.badge-success {
    background: #d4edda;
    color: #155724;
}

.badge-warning {
    background: #fff3cd;
    color: #856404;
}

.badge-danger {
    background: #f8d7da;
    color: #721c24;
}

.badge-info {
    background: #d1ecf1;
    color: #0c5460;
}

.badge-secondary {
    background: #e2e3e5;
    color: #383d41;
}

.action-buttons {
    display: flex;
    gap: 5px;
}

.action-buttons .btn {
    padding: 5px 10px;
    font-size: 12px;
}
</style>

<script>
// Variables globales
let currentWorkflows = [];
let currentApprovals = [];

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    initializeTabs();
    loadData();
    setupEventListeners();
});

function initializeTabs() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Désactiver tous les onglets
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Activer l'onglet sélectionné
            button.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
            
            // Charger les données selon l'onglet
            if (targetTab === 'approvals') {
                loadPendingApprovals();
            }
        });
    });
}

function setupEventListeners() {
    // Bouton nouveau workflow
    document.getElementById('newWorkflowBtn').addEventListener('click', () => {
        document.getElementById('createWorkflowModal').style.display = 'flex';
    });

    // Fermeture des modals
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            modal.style.display = 'none';
        });
    });

    // Recherche et filtres
    document.getElementById('searchWorkflows').addEventListener('input', filterWorkflows);
    document.getElementById('statusFilter').addEventListener('change', filterWorkflows);
}

async function loadData() {
    try {
        await Promise.all([
            loadWorkflowTemplates(),
            loadStats()
        ]);
    } catch (error) {
        console.error('Erreur lors du chargement des données:', error);
    }
}

async function loadWorkflowTemplates() {
    try {
        const token = localStorage.getItem('token') || getCookie('access_token');
        const response = await fetch('/api/workflows', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            currentWorkflows = await response.json();
            renderWorkflowTemplates(currentWorkflows);
        }
    } catch (error) {
        console.error('Erreur lors du chargement des workflows:', error);
    }
}

async function loadPendingApprovals() {
    try {
        const token = localStorage.getItem('token') || getCookie('access_token');
        const response = await fetch('/api/workflow-instances/pending', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            currentApprovals = await response.json();
            renderPendingApprovals(currentApprovals);
        }
    } catch (error) {
        console.error('Erreur lors du chargement des approbations:', error);
    }
}

async function loadStats() {
    // Mettre à jour les statistiques
    document.getElementById('totalWorkflows').textContent = currentWorkflows.length;
    document.getElementById('pendingApprovals').textContent = currentApprovals.length;
    // completedToday sera calculé plus tard
}

function renderWorkflowTemplates(workflows) {
    const tbody = document.querySelector('#workflowTemplatesTable tbody');
    tbody.innerHTML = '';

    workflows.forEach(workflow => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${workflow.nom}</strong></td>
            <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ${workflow.description || 'Aucune description'}
            </td>
            <td>${workflow.createur_prenom} ${workflow.createur_nom}</td>
            <td>
                <span class="badge badge-${workflow.statut === 'ACTIVE' ? 'success' : 'secondary'}">
                    ${workflow.statut}
                </span>
            </td>
            <td>${workflow.instances_count || 0}</td>
            <td>${new Date(workflow.date_creation).toLocaleDateString('fr-FR')}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-info" onclick="viewWorkflow(${workflow.id})">
                        <i class='bx bx-show'></i> Voir
                    </button>
                    <button class="btn btn-danger" onclick="deleteWorkflow(${workflow.id})" 
                            title="Supprimer">
                        <i class='bx bx-trash'></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    if (workflows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #777;">Aucun workflow trouvé</td></tr>';
    }
}

function renderPendingApprovals(approvals) {
    const tbody = document.querySelector('#pendingApprovalsTable tbody');
    tbody.innerHTML = '';

    approvals.forEach(approval => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${approval.document_titre}</strong></td>
            <td>${approval.workflow_nom}</td>
            <td>
                <span class="badge badge-warning">${approval.etape_courante_nom}</span>
            </td>
            <td>${approval.initiateur_prenom} ${approval.initiateur_nom}</td>
            <td>${new Date(approval.date_debut).toLocaleDateString('fr-FR')}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="approveWorkflow(${approval.id})">
                        <i class='bx bx-check'></i> Approuver
                    </button>
                    <button class="btn btn-danger" onclick="rejectWorkflow(${approval.id})">
                        <i class='bx bx-x'></i> Rejeter
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    if (approvals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #777;">Aucune approbation en attente</td></tr>';
    }
}

function filterWorkflows() {
    const searchTerm = document.getElementById('searchWorkflows').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;

    const filtered = currentWorkflows.filter(workflow => {
        const matchesSearch = workflow.nom.toLowerCase().includes(searchTerm) ||
                             (workflow.description && workflow.description.toLowerCase().includes(searchTerm));
        const matchesStatus = statusFilter === 'all' || workflow.statut === statusFilter;
        return matchesSearch && matchesStatus;
    });

    renderWorkflowTemplates(filtered);
}

function approveWorkflow(instanceId) {
    const form = document.getElementById('approveForm');
    form.action = `/workflow/approve/${instanceId}`;
    document.getElementById('approveModal').style.display = 'flex';
}

function rejectWorkflow(instanceId) {
    const form = document.getElementById('rejectForm');
    form.action = `/workflow/reject/${instanceId}`;
    document.getElementById('rejectModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function viewWorkflow(workflowId) {
    // Rediriger vers la page de détails du workflow
    window.location.href = `/workflow/view/${workflowId}`;
}

async function deleteWorkflow(workflowId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce workflow ?')) {
        return;
    }

    try {
        const token = localStorage.getItem('token') || getCookie('access_token');
        const response = await fetch(`/api/workflows/${workflowId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            alert('Workflow supprimé avec succès');
            loadWorkflowTemplates();
        } else {
            const error = await response.json();
            alert('Erreur: ' + (error.error || 'Impossible de supprimer le workflow'));
        }
    } catch (error) {
        console.error('Erreur lors de la suppression:', error);
        alert('Erreur lors de la suppression du workflow');
    }
}

// Fonction utilitaire pour récupérer les cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 